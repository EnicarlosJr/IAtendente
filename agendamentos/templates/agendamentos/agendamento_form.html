{% extends "painel/base.html" %}
{% load widget_tweaks %}
{% block title %}{{ title }}{% endblock %}
{% block header %}{{ title }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-4xl px-4 py-6">

  {% if form.non_field_errors %}
  <div class="mb-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 text-sm">
    {{ form.non_field_errors }}
  </div>
  {% endif %}

  {% if form.errors %}
  <div class="mb-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-800 text-sm">
    Existem erros no formul√°rio. Revise os campos destacados abaixo.
  </div>
  {% endif %}

  <form method="post" class="bg-white rounded-2xl border shadow-sm overflow-hidden" novalidate>
    {% csrf_token %}

    <!-- Cabe√ßalho -->
    <div class="px-6 py-4 border-b bg-slate-50 flex items-center gap-3">
      <span class="w-9 h-9 flex items-center justify-center rounded-xl bg-emerald-100">üíà</span>
      <div>
        <h2 class="text-lg font-semibold text-slate-900">{{ title }}</h2>
        <p class="text-sm text-slate-600">Selecione servi√ßo, cliente e um hor√°rio dispon√≠vel.</p>
      </div>
    </div>

    <!-- Corpo -->
    <div class="px-6 py-6 space-y-8">

      <section>
        <h3 class="text-sm font-semibold text-slate-800 mb-4">1. Barbeiro, data e hor√°rio</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Barbeiro</label>
            <div class="w-full rounded-xl border px-3 py-2 bg-slate-50 flex items-center justify-between">
              <span class="text-slate-800">
                {{ request.user.get_full_name|default:request.user.username }}
              </span>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-slate-200 text-slate-700">Voc√™</span>
            </div>
            {% if form.barbeiro %}{{ form.barbeiro.as_hidden }}{% endif %}
            {% if form.barbeiro.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.barbeiro.errors|striptags }}</p>
            {% endif %}
          </div>


          <div>
            <label for="id_dia" class="block text-sm font-medium text-slate-700 mb-1">Data</label>
            <input type="date"
                   name="dia"
                   id="id_dia"
                   value="{{ dia|date:'Y-m-d' }}"
                   class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10"
                   required>
          </div>

          {# Hor√°rio #}
          <div class="md:col-span-2">
            <label for="id_inicio" class="block text-sm font-medium text-slate-700 mb-1">Hor√°rio</label>
            {% with sel=sel_inicio %}
              <select name="inicio"
                      id="id_inicio"
                      class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10 {% if form.inicio.errors %}border-rose-400 ring-rose-200{% endif %}"
                      required
                      {% if not slots_disponiveis %}disabled aria-disabled="true"{% endif %}>
                {% if slots_disponiveis %}
                  {% for slot in slots_disponiveis %}
                    {% if slot.available %}
                      {% with v=slot.start|date:'Y-m-d\\TH:i' %}
                        <option value="{{ v }}" {% if sel and sel == v %}selected{% endif %}>
                          {{ slot.start|date:"H:i" }}
                        </option>
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <option disabled selected>‚ö† Selecione uma data com disponibilidade</option>
                {% endif %}
              </select>
            {% endwith %}
            {% if form.inicio.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.inicio.errors|striptags }}</p>
            {% endif %}

            {% if not dia %}
              <p class="mt-1 text-xs text-rose-600">‚ö† Selecione uma data para ver hor√°rios.</p>
            {% elif slots_disponiveis|length == 0 %}
              <p class="mt-1 text-xs text-rose-600">‚ö† N√£o h√° disponibilidade configurada neste dia.</p>
            {% endif %}
          </div>
        </div>
      </section>


      <section>
        <h3 class="text-sm font-semibold text-slate-800 mb-4">2. Servi√ßo</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Servi√ßo</label>
            {{ form.servico|add_class:"w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10"|attr:"aria-describedby:help_servico" }}
            {% if form.servico.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.servico.errors|striptags }}</p>
            {% else %}
              <p id="help_servico" class="mt-1 text-xs text-slate-500">Pre√ßo e dura√ß√£o podem ser sugeridos automaticamente.</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Pre√ßo cobrado</label>
            {{ form.preco_cobrado|add_class:"w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10"|attr:"inputmode:decimal" }}
            {% if form.preco_cobrado.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.preco_cobrado.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>
      </section>

      <section>
        <h3 class="text-sm font-semibold text-slate-800 mb-4">3. Cliente</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
            {{ form.cliente|add_class:"w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10" }}
            {% if form.cliente.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.cliente.errors|striptags }}</p>
            {% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Cliente (nome livre)</label>
            {{ form.cliente_nome|add_class:"w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10" }}
            {% if form.cliente_nome.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.cliente_nome.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>
      </section>

      <section>
        <h3 class="text-sm font-semibold text-slate-800 mb-4">4. Finaliza√ß√£o</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
            {{ form.status|add_class:"w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-900/10" }}
            {% if form.status.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.status.errors|striptags }}</p>
            {% endif %}
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-slate-700 mb-1">Observa√ß√µes</label>
            {{ form.observacoes|add_class:"w-full rounded-xl border px-3 py-2 min-h-[96px] focus:outline-none focus:ring-2 focus:ring-slate-900/10" }}
            {% if form.observacoes.errors %}
              <p class="mt-1 text-sm text-rose-600">{{ form.observacoes.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>
      </section>

      {% if debug_info or form.errors %}
      <details class="rounded-xl border bg-slate-50">
        <summary class="px-3 py-2 text-sm font-medium cursor-pointer">[DEBUG]</summary>
        <div class="p-3 space-y-2">
          {% if debug_info %}
            <pre class="text-xs whitespace-pre-wrap rounded-lg border bg-white px-3 py-2">{{ debug_info }}</pre>
          {% endif %}
          {% if form.errors %}
            <pre class="text-xs whitespace-pre-wrap rounded-lg border bg-rose-50 px-3 py-2 text-rose-800">
              errors: {{ form.errors }}
              non_field: {{ form.non_field_errors }}
            </pre>
          {% endif %}
        </div>
      </details>
      {% endif %}
    </div>

    <!-- Rodap√© -->
    <div class="px-6 py-4 border-t bg-slate-50 flex justify-end gap-2">
      <a href="{% url 'agendamentos:agenda_dia' shop.slug %}" class="px-4 py-2 rounded-xl border hover:bg-slate-100">Cancelar</a>
      <button type="submit" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Salvar</button>
    </div>
  </form>
</div>

{# ===================== JS ===================== #}
<script>
(function(){
  // Recarrega a p√°gina preservando filtros quando mudar a data
  const dia = document.getElementById("id_dia");
  function reloadWithParams(){
    const p = new URLSearchParams(window.location.search);
    if (dia && dia.value) p.set("dia", dia.value);
    // Preserve tamb√©m cliente/servi√ßo (se o usu√°rio j√° escolheu)
    const cliente    = document.getElementById("id_cliente");
    const clienteNom = document.getElementById("id_cliente_nome");
    const servico    = document.getElementById("id_servico");
    if (cliente && cliente.value)      p.set("cliente", cliente.value);
    if (clienteNom && clienteNom.value) p.set("cliente_nome", clienteNom.value);
    if (servico && servico.value)      p.set("servico", servico.value);
    window.location.search = p.toString();
  }
  if (dia) dia.addEventListener("change", reloadWithParams);

  // Se futuramente voc√™ renderizar <option data-preco="..."> no select de servi√ßo,
  // este trecho preenche o pre√ßo automaticamente.
  const servico = document.getElementById("id_servico");
  const preco   = document.getElementById("id_preco_cobrado");
  if (servico && preco) {
    servico.addEventListener("change", function(){
      const opt = servico.options[servico.selectedIndex];
      const p = opt ? opt.getAttribute("data-preco") : null;
      if (p && !preco.value) { preco.value = p; }
    });
  }

  // Foco inicial mais inteligente
  const firstError = document.querySelector(".border-rose-400, .ring-rose-200");
  if (firstError) firstError.focus?.();
  else document.getElementById("id_servico")?.focus();
})();
</script>
{% endblock %}
