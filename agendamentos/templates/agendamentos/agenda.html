{% extends "painel/base.html" %}
{% block title %}Agenda — Visão Geral{% endblock %}
{% block header %}Agenda{% endblock %}

{% block content %}
{% include "agendamentos/_agenda_tabs.html" %}

<div class="grid grid-cols-1 xl:grid-cols-3 gap-4">

  {# ================== COLUNA 1: HOJE (essencial) ================== #}
  <section class="card overflow-hidden">
    <div class="flex items-center justify-between px-5 sm:px-6 py-4 soft-divider bg-slate-50/70 backdrop-blur">
      <div class="flex items-center gap-2">
        <h2 class="text-base font-semibold text-slate-900">Hoje</h2>
        <span class="pill bg-slate-100 text-slate-700">{{ base_date|date:"d/m/Y" }}</span>
      </div>
      <div class="flex gap-2">
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ prev_day|date:'Y-m-d' }}">←</a>
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ next_day|date:'Y-m-d' }}">→</a>
      </div>
    </div>

    {# Próximo compromisso #}
    {# Próximo compromisso #}
    <div class="p-5 sm:p-6">
      {% if next_item %}
      <div class="rounded-2xl border border-emerald-200 bg-emerald-50/70 p-4">
        <div class="flex items-center justify-between">
          <div class="text-sm ia-text-muted">Próximo</div>
          <span class="pill bg-emerald-100 text-emerald-700 text-[11px]">{{ next_item.status }}</span>
        </div>
        <div class="mt-1 flex items-baseline gap-3">
          <div class="text-2xl font-bold text-slate-900">
            {{ next_item.inicio|date:"H:i" }}
          </div>
          <div class="truncate">
            <div class="font-medium text-slate-900 truncate">{{ next_item.cliente_nome }}</div>
            <div class="text-xs ia-text-muted truncate">{{ next_item.servico_nome }}</div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="rounded-2xl border border-dashed border-emerald-300 bg-white p-4 text-sm text-emerald-700">
        Nenhum atendimento marcado — tudo livre por enquanto.
      </div>
      {% endif %}
    </div>

    {# Próximos de hoje (limite 5) #}
    <div class="px-5 sm:px-6 pb-5">
      <h3 class="section-title mb-2">Próximos de hoje</h3>
      <ul class="divide-y divide-slate-100 rounded-xl border border-slate-200 bg-white">
        {% with count=0 %}
        {% for row in today_rows %}
        {% if row.item %}
        {% if count < 5 %} <li class="flex items-center justify-between px-3 py-2">
          <div class="w-16 shrink-0 text-sm ia-text-muted">{{ row.time|date:"H:i" }}</div>
          <div class="flex-1 mx-3 min-w-0">
            <div class="font-medium text-slate-900 truncate">{{ row.item.cliente_nome }}</div>
            <div class="text-xs ia-text-muted truncate">{{ row.item.servico_nome }}</div>
          </div>
          <span class="pill text-[10px]
                    {% if row.item.status == 'CONFIRMADO' or row.item.status == 'CONFIRMADA' %} bg-emerald-100 text-emerald-700
                    {% elif row.item.status == 'PENDENTE' %} bg-amber-100 text-amber-800
                    {% else %} bg-slate-100 text-slate-700 {% endif %}">
            {{ row.item.status }}
          </span>
          </li>
          {% with count=count|add:"1" %}{% endwith %}
          {% endif %}
          {% endif %}
          {% endfor %}
          {% if count == 0 %}
          <li class="px-3 py-4 text-sm ia-text-muted text-center">Nenhum atendimento para hoje.</li>
          {% endif %}
          {% endwith %}
      </ul>
    </div>
  </section>

  {# ================== COLUNA 2: SEMANA (cards enxutos) ================== #}
  <section class="card overflow-hidden">
    <div class="flex items-center justify-between px-5 sm:px-6 py-4 soft-divider bg-slate-50/70 backdrop-blur">
      <div class="flex items-center gap-2">
        <h2 class="text-base font-semibold text-slate-900">Semana</h2>
        <span class="pill bg-slate-100 text-slate-700">{{ wk_start|date:"d/m" }} — {{ wk_end|date:"d/m" }}</span>
      </div>
      <div class="flex gap-2">
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ prev_week|date:'Y-m-d' }}">←</a>
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ next_week|date:'Y-m-d' }}">→</a>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-4">
      {% for col in week_cols %}
      <a href="{% url 'agendamentos:agenda_dia' shop.slug %}?dia={{ col.date|date:'Y-m-d' }}"
        class="rounded-2xl border border-slate-200 bg-white p-3 hover:shadow-sm transition">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-900">
            {{ col.date|date:"D" }} · {{ col.date|date:"d/m" }}
          </div>
          <span class="pill bg-slate-100 text-slate-700 text-[11px]">{{ col.total }}</span>
        </div>
        <div class="mt-2 flex items-center gap-3 text-[11px]">
          <span class="pill bg-emerald-100 text-emerald-700">OK {{ col.confirmados }}</span>
          <span class="pill bg-amber-100 text-amber-800">Pend. {{ col.pendentes }}</span>
          {% if col.cancelados %}
          <span class="pill bg-rose-100 text-rose-700">Canc. {{ col.cancelados }}</span>
          {% endif %}
        </div>
        {% if col.top %}
        <div class="mt-2 text-[12px] ia-text-muted truncate">
          Próx.: <span class="font-medium text-slate-900">{{ col.top.0.inicio|date:"H:i" }}</span>
          · {{ col.top.0.cliente_nome }}
        </div>
        {% endif %}
      </a>
      {% endfor %}
    </div>
  </section>

  {# ================== COLUNA 3: MINI-MÊS (somente contagem) ================== #}
  <section class="card overflow-hidden">
    <div class="flex items-center justify-between px-5 sm:px-6 py-4 soft-divider bg-slate-50/70 backdrop-blur">
      <h2 class="text-base font-semibold text-slate-900">{{ ref_date|date:"F Y" }}</h2>
      <div class="flex gap-2">
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ prev_month|date:'Y-m-d' }}">←</a>
        <a class="btn btn-secondary"
          href="{% url 'agendamentos:agenda' shop.slug %}?data={{ next_month|date:'Y-m-d' }}">→</a>
      </div>
    </div>

    <div class="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
      {% for label in month_labels %}
      <div class="text-center text-xs font-semibold ia-text-muted py-2">{{ label }}</div>
      {% endfor %}
    </div>

    <div class="grid grid-cols-7 gap-px bg-slate-200 p-px">
      {% for _ in blank_cells %}
      <div class="bg-white min-h-[84px]"></div>
      {% endfor %}
      {% for cell in month_days %}
      <a href="{% url 'agendamentos:agenda_dia' shop.slug %}?dia={{ cell.date|date:'Y-m-d' }}"
        class="bg-white min-h-[84px] p-2 hover:bg-slate-50 transition">
        <div class="flex items-center justify-between">
          <div class="text-xs ia-text-muted">{{ cell.date|date:"d" }}</div>
          {% if cell.count %}
          <span class="pill text-[10px]
                {% if cell.count <= 2 %} bg-emerald-100 text-emerald-700
                {% elif cell.count <= 4 %} bg-emerald-200 text-emerald-800
                {% else %} bg-emerald-300 text-emerald-900 {% endif %}">
            {{ cell.count }}
          </span>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}