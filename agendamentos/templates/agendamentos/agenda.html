{% extends "painel/base.html" %}
{% block title %}Agenda — Visão Geral{% endblock %}
{% block header %}Agenda{% endblock %}

{% block content %}
{% include "agendamentos/_agenda_tabs.html" %}

<div class="grid grid-cols-1 xl:grid-cols-3 gap-4">

  {# ===== COLUNA 1: HOJE (timeline) ===== #}
  <section class="xl:col-span-1 rounded-xl border border-gray-200 bg-white overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
      <div class="font-semibold">Hoje · {{ base_date|date:"d/m/Y" }}</div>
      <div class="flex gap-2">
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ prev_day|date:'Y-m-d' }}">←</a>
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ next_day|date:'Y-m-d' }}">→</a>
      </div>
    </div>
    <ul class="divide-y divide-gray-100">
      {% for row in today_rows %}
        <li class="flex items-center justify-between px-4 py-2">
          <div class="w-16 shrink-0 text-sm text-gray-500">{{ row.time|date:"H:i" }}</div>
          {% if row.item %}
            <div class="flex-1 mx-4 min-w-0">
              <div class="font-medium text-gray-900 truncate">{{ row.item.cliente_nome }}</div>
              <div class="text-xs text-gray-600 truncate">{{ row.item.servico_nome }}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded-full
              {% if row.item.status == 'CONFIRMADO' %} bg-emerald-100 text-emerald-700
              {% elif row.item.status == 'PENDENTE' %}  bg-amber-100 text-amber-700
              {% else %}                            bg-rose-100 text-rose-700 {% endif %}">
              {{ row.item.status }}
            </span>
          {% else %}
            <div class="flex-1 mx-4 text-xs text-gray-400">Livre</div>
            <a href="#" class="text-xs px-2 py-1 rounded border bg-white hover:bg-gray-50">Agendar</a>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </section>

  {# ===== COLUNA 2: SEMANA (resumo compacto) ===== #}
  <section class="xl:col-span-1 rounded-xl border border-gray-200 bg-white overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
      <div class="font-semibold">Semana · {{ wk_start|date:"d/m" }} — {{ wk_end|date:"d/m" }}</div>
      <div class="flex gap-2">
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ prev_week|date:'Y-m-d' }}">←</a>
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ next_week|date:'Y-m-d' }}">→</a>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 p-3">
      {% for col in week_cols %}
        <div class="border border-gray-200 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">{{ col.date|date:"D" }} · {{ col.date|date:"d/m" }}</div>
            <span class="text-[11px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-700">{{ col.total }}</span>
          </div>
          <div class="mt-1 text-[11px] text-gray-600">
            <span class="text-emerald-700">● {{ col.confirmados }}</span>
            <span class="ms-2 text-amber-700">● {{ col.pendentes }}</span>
            <span class="ms-2 text-rose-700">● {{ col.cancelados }}</span>
          </div>
          <ul class="mt-2 space-y-1">
            {% for a in col.top %}
              <li class="text-xs rounded border border-gray-200 px-2 py-1">
                <span class="font-medium">{{ a.inicio|date:"H:i" }}</span>
                <span class="text-gray-600">· {{ a.cliente_nome }}</span>
              </li>
            {% empty %}
              <li class="text-xs text-gray-400">Livre</li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  </section>

  {# ===== COLUNA 3: MINI-MÊS ===== #}
  <section class="xl:col-span-1 rounded-xl border border-gray-200 bg-white overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200">
      <div class="font-semibold">{{ ref_date|date:"F Y" }}</div>
      <div class="flex gap-2">
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ prev_month|date:'Y-m-d' }}">←</a>
        <a class="text-sm px-2.5 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
           href="{% url 'agendamentos:agenda' %}?data={{ next_month|date:'Y-m-d' }}">→</a>
      </div>
    </div>

    <div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200">
      {% for label in month_labels %}
        <div class="text-center text-xs font-medium text-gray-600 py-2">{{ label }}</div>
      {% endfor %}
    </div>

    <div class="grid grid-cols-7 gap-px bg-gray-200 p-px">
      {% for _ in blank_cells %}
        <div class="bg-white min-h-[90px]"></div>
      {% endfor %}

      {% for cell in month_days %}
        <div class="bg-white min-h-[90px] p-2">
          <div class="flex items-center justify-between">
            <div class="text-xs text-gray-500">{{ cell.date|date:"d" }}</div>
            {% if cell.count %}
              <span class="text-[10px] px-1.5 py-0.5 rounded-full
                {% if cell.count <= 2 %} bg-emerald-100 text-emerald-700
                {% elif cell.count <= 4 %} bg-emerald-200 text-emerald-800
                {% else %}               bg-emerald-300 text-emerald-900 {% endif %}">
                {{ cell.count }}
              </span>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
</div>
{% endblock %}
