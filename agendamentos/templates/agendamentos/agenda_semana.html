{% extends "painel/base.html" %}
{% block title %}Agenda ‚Äî Semana{% endblock %}
{% block header %}Agenda{% endblock %}

{% block content %}
{% include "agendamentos/_agenda_tabs.html" %}

<div class="card overflow-hidden">

  <!-- Cabe√ßalho -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 px-5 sm:px-6 py-4 border-b border-slate-200 bg-slate-50/70 backdrop-blur">
    <h2 class="text-lg font-semibold text-slate-900 flex items-center gap-2">
      <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-blue-100 text-blue-600">üìÖ</span>
      Semana: {{ wk_start|date:"d/M" }} ‚Äî {{ wk_end|date:"d/M" }}
    </h2>

    <div class="flex items-center gap-2">
      <a class="btn btn-secondary"
         href="{% url 'agendamentos:agenda_semana' shop.slug %}?data={{ prev_week|date:'Y-m-d' }}">‚Üê Semana anterior</a>
      <a class="btn btn-secondary"
         href="{% url 'agendamentos:agenda_semana' shop.slug %}?data={{ next_week|date:'Y-m-d' }}">Pr√≥xima semana ‚Üí</a>
    </div>
  </div>

  <!-- Legenda -->
  <div class="px-5 sm:px-6 py-2 border-b border-slate-100 bg-white">
    <div class="flex flex-wrap items-center gap-2 text-[11px]">
      <span class="pill bg-emerald-100 text-emerald-800">Livre</span>
      <span class="pill bg-amber-100 text-amber-800">Almo√ßo</span>
      <span class="pill bg-slate-200 text-slate-700">Folga</span>
      <span class="pill bg-gray-100 text-gray-700">Ocupado</span>
      <span class="pill bg-blue-100 text-blue-700">Confirmado</span>
      <span class="pill bg-rose-100 text-rose-700">Cancelado/Negado</span>
      <span class="pill bg-amber-100 text-amber-800">Pendente</span>
    </div>
  </div>

  <!-- Grade principal -->
  <div class="overflow-x-auto">
    <div class="min-w-[980px]">

      <!-- Cabe√ßalho dos dias -->
      <div class="grid grid-cols-8 bg-slate-50 border-b border-slate-200 text-xs font-medium text-slate-600">
        <div class="py-2 px-3">Hora</div>
        {% for col in days_ctx %}
          <div class="py-2 text-center">
            <div>{{ col.label }}</div>
            <div class="text-[11px] text-slate-500">{{ col.date|date:"d/M" }}</div>
          </div>
        {% endfor %}
      </div>

      <!-- Linhas de hor√°rios -->
      {% for r in rows %}
        <div class="grid grid-cols-8 border-b border-slate-100 text-xs">
          <!-- Coluna da hora -->
          <div class="px-3 py-2 text-slate-600 font-semibold">{{ r.time|date:"H:i" }}</div>

          <!-- Colunas/dias -->
          {% for c in r.cells %}
            <div class="px-2 py-2 border-l border-slate-50">
              {% if c.item %}
                {% with status_code=c.item.status|stringformat:"s"|upper %}
                  <a href="{% url 'solicitacoes:detalhe' shop.slug c.item.id %}"
                     class="block rounded-xl border p-3 shadow-sm hover:shadow-md hover:border-slate-300 transition transform hover:-translate-y-0.5
                           {% if status_code in 'CONFIRMADA CONFIRMADO' %} border-blue-200 bg-blue-50/60
                           {% elif status_code == 'PENDENTE' %}        border-amber-200 bg-amber-50/60
                           {% elif status_code in 'NEGADA CANCELADA' %} border-rose-200 bg-rose-50/60
                           {% else %}                                   border-slate-200 bg-white {% endif %}">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[11px] ia-text-muted">
                        {{ c.item.inicio|date:"H:i" }}‚Äì{{ c.item.fim|date:"H:i" }}
                      </div>
                      <span class="pill text-[11px] font-medium
                        {% if status_code in 'CONFIRMADA CONFIRMADO' %} bg-blue-100 text-blue-700
                        {% elif status_code == 'PENDENTE' %}            bg-amber-100 text-amber-800
                        {% elif status_code in 'NEGADA CANCELADA' %}     bg-rose-100 text-rose-700
                        {% else %}                                       bg-slate-100 text-slate-700 {% endif %}">
                        {{ c.item.status }}
                      </span>
                    </div>

                    <div class="mt-1">
                      <div class="text-[13px] font-semibold text-slate-900 truncate" title="{{ c.item.cliente_nome }}">
                        {{ c.item.cliente_nome }}
                      </div>
                      <div class="text-[12px] ia-text-muted truncate" title="{{ c.item.servico_nome }}">
                        {{ c.item.servico_nome }}
                      </div>
                    </div>

                    {% if c.conflicts and c.conflicts > 0 %}
                      <div class="text-[11px] text-rose-700 mt-1">‚ö†Ô∏è +{{ c.conflicts }} conflito(s)</div>
                    {% endif %}
                  </a>
                {% endwith %}

              {% elif c.occupied %}
                <div class="rounded-xl border border-dashed border-slate-300 p-3 bg-slate-50 text-center ia-text-muted shadow-sm">
                  Ocupado
                </div>

              {% else %}
                {% if not c.available and c.reason == 'almoco' %}
                  <div class="rounded-xl p-3 text-center bg-amber-50 border border-amber-100 shadow-sm">
                    <span class="pill bg-amber-100 text-amber-800">üçΩÔ∏è Almo√ßo</span>
                  </div>
                {% elif not c.available and c.reason == 'folga' %}
                  <div class="rounded-xl p-3 text-center bg-slate-50 border border-slate-200 shadow-sm">
                    <span class="pill bg-slate-200 text-slate-700">üõë Folga</span>
                  </div>
                {% else %}
                  <a href="{% url 'solicitacoes:solicitacoes' shop.slug %}?inicio={{ c.time|date:'Y-m-d\\TH:i' }}"
                     class="block rounded-xl border border-dashed border-emerald-300 p-3 bg-white hover:bg-emerald-50 hover:shadow-md transition text-center shadow-sm">
                    <span class="text-[12px] font-medium text-emerald-700">‚ûï Livre ¬∑ Agendar</span>
                  </a>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
