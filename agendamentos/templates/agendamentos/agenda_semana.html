{% extends "painel/base.html" %}
{% block title %}Agenda ‚Äî Semana{% endblock %}
{% block header %}Agenda{% endblock %}

{% block content %}
{% include "agendamentos/_agenda_tabs.html" %}

<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">

  <!-- Cabe√ßalho -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 px-4 py-3 border-b border-gray-200">
    <div class="font-semibold text-lg">üìÖ Semana: {{ wk_start|date:"d/M" }} ‚Äî {{ wk_end|date:"d/M" }}</div>
    <div class="flex gap-2">
      <a class="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
         href="{% url 'agendamentos:agenda_semana' shop.slug %}?data={{ prev_week|date:'Y-m-d' }}">‚Üê Semana anterior</a>
      <a class="text-sm px-3 py-1.5 rounded-lg border bg-white hover:bg-gray-50"
         href="{% url 'agendamentos:agenda_semana' shop.slug %}?data={{ next_week|date:'Y-m-d' }}">Pr√≥xima semana ‚Üí</a>
    </div>
  </div>

  <!-- Legenda -->
  <div class="px-4 py-2 border-b border-gray-100">
    <div class="flex flex-wrap items-center gap-2 text-xs">
      <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800">Livre</span>
      <span class="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">Almo√ßo</span>
      <span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-700">Folga</span>
      <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">Ocupado</span>
      <span class="px-2 py-0.5 rounded-full bg-emerald-200 text-emerald-900">Agendamento</span>
      <span class="px-2 py-0.5 rounded-full bg-rose-100 text-rose-700">Conflito</span>
    </div>
  </div>

  <!-- Grade principal (scroll em telas menores) -->
  <div class="overflow-x-auto">
    <div class="min-w-[900px]">
      <!-- Cabe√ßalho dos dias -->
      <div class="grid grid-cols-8 bg-gray-50 border-b border-gray-200 text-xs font-medium text-gray-600">
        <div class="py-2 px-3">Hora</div>
        {% for col in days_ctx %}
          <div class="py-2 text-center">
            {{ col.label }}<br>
            <span class="text-[11px] text-gray-500">{{ col.date|date:"d/M" }}</span>
          </div>
        {% endfor %}
      </div>

      <!-- Linhas de hor√°rios -->
      {% for r in rows %}
        <div class="grid grid-cols-8 border-b border-gray-100 text-xs">
          <!-- Coluna da hora -->
          <div class="px-3 py-2 text-gray-600 font-medium">{{ r.time|date:"H:i" }}</div>

          <!-- Colunas de cada dia -->
          {% for c in r.cells %}
            <div class="px-2 py-2 border-l border-gray-50">
              {% if c.item %}
                {% with status_code=c.item.status|stringformat:"s"|upper %}
                  <!-- Agendamento -->
                  <div class="rounded-lg border border-emerald-200 bg-emerald-50/60 p-2 shadow-sm">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[11px] text-gray-500">
                        {{ c.item.inicio|date:"H:i" }}‚Äì{{ c.item.fim|date:"H:i" }}
                      </div>
                      <span class="inline-block text-[11px] px-2 py-0.5 rounded-full
                        {% if status_code in "CONFIRMADA CONFIRMADO" %}
                          bg-emerald-100 text-emerald-700
                        {% elif status_code == "PENDENTE" %}
                          bg-amber-100 text-amber-700
                        {% elif status_code in "NEGADA CANCELADA" %}
                          bg-rose-100 text-rose-700
                        {% else %}
                          bg-gray-100 text-gray-700
                        {% endif %}"
                        title="Status: {{ c.item.status }}">
                        {{ c.item.status }}
                      </span>
                    </div>

                    <div class="text-sm font-medium truncate mt-1" title="{{ c.item.cliente_nome }}">{{ c.item.cliente_nome }}</div>
                    <div class="text-xs text-gray-600 truncate" title="{{ c.item.servico_nome }}">{{ c.item.servico_nome }}</div>

                    {% if c.conflicts and c.conflicts > 0 %}
                      <div class="text-[11px] text-rose-700 mt-1">‚ö†Ô∏è +{{ c.conflicts }} conflito(s)</div>
                    {% endif %}

                    <div class="mt-2">
                      <a href="{% url 'solicitacoes:detalhe' shop.slug c.item.id %}"  {# <= apenas ID, como no _agenda_card.html #}
                         class="text-[11px] underline">Ver detalhes</a>
                    </div>
                  </div>
                {% endwith %}

              {% elif c.occupied %}
                <!-- Ocupado (dentro da janela de um agendamento) -->
                <div class="rounded-lg border border-dashed border-gray-300 p-2 bg-gray-50 text-center text-gray-500">
                  Ocupado
                </div>

              {% else %}
                <!-- Livre / Almo√ßo / Folga -->
                {% if not c.available and c.reason == 'almoco' %}
                  <div class="rounded-lg p-2 text-center bg-amber-50 border border-amber-100">
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">üçΩÔ∏è Almo√ßo</span>
                  </div>
                {% elif not c.available and c.reason == 'folga' %}
                  <div class="rounded-lg p-2 text-center bg-slate-50 border border-slate-200">
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-slate-200 text-slate-700">üõë Folga</span>
                  </div>
                {% else %}
                  <div class="rounded-lg border border-dashed border-emerald-200 p-2 bg-white text-center">
                    {# Igual ao _agenda_card.html: sem shop.slug. Se sua rota exigir slug, me diga o pattern que adapto. #}
                    <a href="{% url 'solicitacoes:solicitacoes' shop.slug %}?inicio={{ c.time|date:'Y-m-d\\TH:i' }}"
                      class="block h-full w-full rounded-lg border border-dashed border-emerald-300 bg-white hover:bg-emerald-50 
                              flex items-center justify-center text-[12px] font-medium text-emerald-700 transition"
                      title="Agendar neste hor√°rio">
                      ‚ûï Livre ¬∑ Agendar
                    </a>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
