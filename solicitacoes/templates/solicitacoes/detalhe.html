{# templates/solicitacoes/detalhe.html #}
{% extends "painel/base.html" %}
{% load l10n %}

{% block title %}{% if tipo == 'agendamento' %}Agendamento{% else %}Solicitação{% endif %} #{{ obj.id }}{% endblock %}
{% block header %}{% if tipo == 'agendamento' %}Agendamento{% else %}Solicitação{% endif %} #{{ obj.id }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-5xl px-4 py-6 space-y-6">

  {# Voltar #}
  {% if tipo == "agendamento" %}
    <a href="{% url 'agendamentos:agenda_dia' shop.slug %}" class="text-sm text-gray-600 hover:underline">← Voltar para agenda</a>
  {% else %}
    <a href="{% url 'solicitacoes:solicitacoes' shop.slug %}" class="text-sm text-gray-600 hover:underline">← Voltar para solicitações</a>
  {% endif %}

  {# ===================== Cabeçalho ===================== #}
  <div class="bg-white rounded-2xl border p-4 flex items-start justify-between gap-6">
    <div>
      <h2 class="text-xl font-semibold text-gray-900">
        {% firstof obj.cliente_nome obj.cliente.nome obj.nome "Cliente" %}
        <span class="text-gray-500 font-normal">· {% firstof obj.telefone obj.cliente.telefone "—" %}</span>
      </h2>

      <p class="text-gray-600 mt-1">
        Serviço:
        <span class="font-medium">
          {% firstof obj.servico_nome obj.servico_label obj.servico.nome "—" %}
        </span>
        {% if obj.servico_id %}
          <span class="text-xs text-gray-500">(catálogo)</span>
        {% else %}
          <span class="text-xs text-gray-500">(snapshot)</span>
        {% endif %}

        {% if tipo == "agendamento" and obj.barbeiro %}
          <span class="ml-2 text-gray-500">· Barbeiro:
            <span class="font-medium">{% firstof obj.barbeiro.get_full_name obj.barbeiro.username "—" %}</span>
          </span>
        {% endif %}
      </p>
    </div>

    <div>
      {% include "solicitacoes/partials/_status_badge.html" with status=obj.status label=obj.status size="xs" only %}
    </div>
  </div>

  {# ===================== Conteúdo ===================== #}
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    {# ----- Detalhes ----- #}
    <div class="bg-white rounded-2xl border p-4 space-y-3">
      <h3 class="text-sm font-semibold text-gray-900 tracking-wide uppercase">Detalhes</h3>
      <div class="text-sm text-gray-700 space-y-2">
        <div>
          <span class="text-gray-500">Telefone:</span>
          {% firstof obj.telefone obj.cliente.telefone "—" %}
        </div>

        <div>
          <span class="text-gray-500">Preço:</span>
          {% firstof obj.preco_cobrado obj.preco_cotado obj.preco as preco %}
          {% if preco is not None %} R$ {{ preco|floatformat:2|localize }} {% else %} — {% endif %}
        </div>

        <div>
          <span class="text-gray-500">Duração (min):</span>
          {% firstof obj.duracao_min obj.duracao_min_cotada "—" %}
        </div>

        <div>
          <span class="text-gray-500">{% if tipo == 'agendamento' %}Início{% else %}Preferência / Início{% endif %}:</span>
          {% if obj.inicio %} {{ obj.inicio|date:"d/m/Y H:i" }} {% else %} — {% endif %}
        </div>

        <div>
          <span class="text-gray-500">Fim:</span>
          {% if obj.fim %} {{ obj.fim|date:"d/m/Y H:i" }} {% else %} — {% endif %}
        </div>

        {% if obj.observacoes %}
          <div>
            <span class="text-gray-500">Observações:</span>
            <span>{{ obj.observacoes }}</span>
          </div>
        {% endif %}

        <div class="text-xs text-gray-500 pt-2">
          Criado em {{ obj.criado_em|date:"d/m/Y H:i"|default:"—" }}
        </div>
      </div>
    </div>

    {# ----- Ações ----- #}
    <div class="space-y-6">

      {# === Ações para SOLICITAÇÃO === #}
      {% if tipo == "solicitacao" %}

        <!-- Confirmar -->
        <div class="bg-white rounded-2xl border p-4">
          <h3 class="text-sm font-semibold text-gray-900 tracking-wide uppercase mb-3">Confirmar horário</h3>
          <form method="post" action="{% url 'solicitacoes:confirmar' shop.slug obj.id %}" class="space-y-3">
            {% csrf_token %}

            <div>
              <label class="text-sm text-gray-700">Horário de início</label>
              <input type="datetime-local" name="inicio"
                     value="{% if obj.inicio %}{{ obj.inicio|date:'Y-m-d\\TH:i' }}{% endif %}"
                     class="rounded-xl border px-3 py-2 w-full" required>
            </div>

            <div>
              <label class="text-sm text-gray-700">Serviço (catálogo)</label>
              <select name="servico_id" class="rounded-xl border px-3 py-2 w-full">
                <option value="">— manter atual —</option>
                {% for item in servicos %}
                  <option value="{{ item.id }}" {% if obj.servico_id == item.id %}selected{% endif %}>
                    {{ item.nome }} — {{ item.duracao_min }}min · R$ {{ item.preco|floatformat:2|localize }}
                  </option>
                {% endfor %}
              </select>
              <p class="text-xs text-gray-500">Se escolher, atualiza os snapshots (nome, preço, duração).</p>
            </div>

            <div>
              <label class="text-sm text-gray-700">Preço cotado (opcional)</label>
              <input type="number" step="0.01" name="preco_cotado"
                     value="{% if obj.preco_cotado is not None %}{{ obj.preco_cotado }}{% endif %}"
                     class="rounded-xl border px-3 py-2 w-full" placeholder="Ex.: 45.00">
            </div>

            <div class="pt-2 flex gap-2">
              <button class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">Confirmar</button>
            </div>
          </form>
        </div>

        <!-- Recusar -->
        <div class="bg-white rounded-2xl border p-4">
          <h3 class="text-sm font-semibold text-gray-900 tracking-wide uppercase mb-3">Recusar solicitação</h3>
          <form method="post" action="{% url 'solicitacoes:recusar' shop.slug obj.id %}" class="space-y-3">
            {% csrf_token %}
            <textarea name="motivo" rows="2" class="rounded-xl border px-3 py-2 w-full"
                      placeholder="Motivo (opcional)"></textarea>
            <button class="rounded-xl px-4 py-2 border text-gray-800 hover:bg-gray-50">Recusar</button>
          </form>
        </div>

      {% else %}

      {# === Ações para AGENDAMENTO === #}
        <div class="bg-white rounded-2xl border p-4">
          <h3 class="text-sm font-semibold text-gray-900 tracking-wide uppercase mb-3">Pós-atendimento</h3>

          <div class="flex flex-wrap gap-2">
            <form method="post" action="{% url 'solicitacoes:finalizar' shop.slug obj.id %}">
              {% csrf_token %}
              <button class="rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700">Finalizar</button>
            </form>
            <form method="post" action="{% url 'solicitacoes:no_show' shop.slug obj.id %}">
              {% csrf_token %}
              <button class="rounded-xl px-4 py-2 bg-amber-600 text-white hover:bg-amber-700">Marcar no-show</button>
            </form>
          </div>

          <p class="text-xs text-gray-500 mt-2">Finalizar só é permitido após o horário de início.</p>

          <div class="mt-4">
            <a href="{% url 'agendamentos:agendamento_novo' shop.slug %}?dia={{ obj.inicio|date:'Y-m-d' }}&inicio={{ obj.inicio|date:'Y-m-d\\TH:i' }}&cliente={{ obj.cliente_id }}&cliente_nome={{ obj.cliente_nome|urlencode }}&servico={{ obj.servico_id }}"
               class="text-xs underline text-gray-600">Reagendar/duplicar este horário</a>
          </div>
        </div>

      {% endif %}

    </div>
  </div>

</div>
{% endblock %}
