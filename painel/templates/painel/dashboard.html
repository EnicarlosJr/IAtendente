{% extends "painel/base.html" %}
{% block title %}Dashboard · IAtendente{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="relative">
  <!-- Fundo decorativo -->
  <div aria-hidden="true" class="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
    <div class="absolute -top-24 -left-24 h-72 w-72 rounded-full bg-gradient-to-tr from-blue-200 to-emerald-200 opacity-30 blur-3xl"></div>
    <div class="absolute top-1/2 -right-40 h-96 w-96 rounded-full bg-gradient-to-tr from-fuchsia-200 to-indigo-200 opacity-25 blur-3xl"></div>
  </div>
  <svg aria-hidden="true" class="absolute inset-0 -z-10 h-full w-full opacity-10">
    <defs>
      <pattern id="gridPattern" width="32" height="32" patternUnits="userSpaceOnUse">
        <path d="M 32 0 L 0 0 0 32" fill="none" stroke="currentColor" stroke-width="0.5"></path>
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#gridPattern)" class="text-slate-300"></rect>
  </svg>

  <div class="mx-auto max-w-7xl px-3 sm:px-4 py-6 space-y-6">

    <!-- HEADER -->
    <section class="card p-5 bg-gradient-to-r from-slate-50/80 to-white/80 backdrop-blur">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          {% with dia=hoje|default:now %}
            <div class="text-xs uppercase tracking-wide text-slate-500">Hoje</div>
            <h1 class="text-xl md:text-2xl font-semibold text-slate-900">
              {{ dia|date:"d/m/Y" }} ({{ dia|date:"l"|capfirst }})
            </h1>
          {% endwith %}
          {% if proximos and proximos.0 %}
            <p class="mt-1 text-xs text-slate-500">
              Próximo: <strong>{{ proximos.0.inicio|date:"H:i" }}</strong>
              — {{ proximos.0.nome|default:proximos.0.telefone }}
              {% if proximos.0.servico %}
                · {{ proximos.0.servico.nome|default:proximos.0.servico }}
              {% endif %}
            </p>
          {% endif %}
        </div>

        <!-- Status rápido -->
        <div class="flex flex-wrap items-center gap-2">
          <span class="pill bg-slate-100 text-slate-700">🕘 {{ kpis.utilizacao_hoje|default:0 }}% ocupação</span>
          <span class="pill bg-slate-100 text-slate-700">⏱️ {{ workday_label|default:"08h–20h" }}</span>
          {% if agenda_hoje %}
            <span class="pill bg-slate-100 text-slate-700">📋 {{ agenda_hoje|length }} agendamentos</span>
          {% endif %}
          {% if solicitacoes_pendentes_count|default:0 > 0 %}
            <a href="{% url 'painel:solicitacoes' %}" class="pill bg-amber-100 text-amber-800 hover:bg-amber-200">
              🔔 Pendências: <strong>{{ solicitacoes_pendentes_count }}</strong>
            </a>
          {% else %}
            <span class="pill bg-slate-100 text-slate-500">🔔 Pendências: 0</span>
          {% endif %}
          <a href="{% url 'agendamentos:agenda_dia' %}" class="btn btn-primary ml-1">📅 Abrir agenda</a>
          <a href="{% url 'agendamentos:minha_agenda_config' %}" class="btn btn-outline">🗓️ Minha agenda</a>
        </div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
      {% include "painel/partials/kpi.html" with label="Faturamento (mês)" icon="💰" val=kpis.faturamento_mes money=True delta=kpis_delta.fat_pct hint="Atendimentos concluídos (sem falta)." %}
      {% include "painel/partials/kpi.html" with label="Clientes novos (mês)" icon="🆕" val=kpis.clientes_novos_mes delta=kpis_delta.clientes_pct hint="Criados neste mês." %}
      {% include "painel/partials/kpi_occup.html" with u=kpis.utilizacao_hoje workday_label=workday_label %}
      {% include "painel/partials/kpi.html" with label="Ticket médio (mês)" icon="🎟️" val=kpis.ticket_medio money=True delta=kpis_delta.ticket_pct hint="Faturamento ÷ atendimentos." %}
    </section>

    <!-- 3 COLUNAS -->
    <section class="grid grid-cols-1 xl:grid-cols-3 gap-4 mt-4">

      <!-- COLUNA 1 -->
      <div class="space-y-4">
        {% include "painel/partials/chart_card.html" with title="Evolução do faturamento (mês)" subtitle="Diário" chart_id="chartFat" has_data=chart_fat_values %}
        {% include "painel/partials/chart_card.html" with title="Horários de pico (últimos 30 dias)" subtitle="Solicitações confirmadas" chart_id="chartPeak" has_data=chart_peak_values %}
      </div>

      <!-- COLUNA 2 -->
      <div class="space-y-4">
        {% include "painel/partials/chart_card.html" with title="Serviços mais executados (mês)" subtitle="Top 8" chart_id="chartSrv" has_data=chart_srv_values %}
        {% include "painel/partials/ranking_clientes.html" %}
      </div>

      <!-- COLUNA 3 -->
      <div class="space-y-4">
        {% include "painel/partials/proximos.html" %}
        {% include "painel/partials/funil.html" %}
        {% include "painel/partials/qualidade.html" %}
        {% include "painel/partials/alertas.html" %}
      </div>
    </section>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const money = (v)=>`R$ ${Number(v ?? 0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2})}`;

  const charts = [
    {id:'chartFat', type:'line', labels:{{ chart_fat_labels|default:"[]"|safe }}, values:{{ chart_fat_values|default:"[]"|safe }},
      opts:{plugins:{legend:{display:false},tooltip:{callbacks:{label:(ctx)=>money(ctx.parsed.y)}}},scales:{y:{beginAtZero:true},x:{grid:{display:false}}}}},
    {id:'chartPeak', type:'line', labels:{{ chart_peak_labels|default:"[]"|safe }}, values:{{ chart_peak_values|default:"[]"|safe }},
      opts:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{grid:{display:false}}}}},
    {id:'chartSrv', type:'bar', labels:{{ chart_srv_labels|default:"[]"|safe }}, values:{{ chart_srv_values|default:"[]"|safe }},
      opts:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{beginAtZero:true},y:{ticks:{autoSkip:false}}}}}
  ];

  charts.forEach(c=>{
    const el=document.getElementById(c.id);
    if(el){
      new Chart(el,{
        type:c.type,
        data:{labels:c.labels,datasets:[{data:c.values,tension:.35,pointRadius:2,borderWidth:1}]},
        options:c.opts
      });
    }
  });
</script>
{% endblock %}
