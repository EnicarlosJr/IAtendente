{% extends "painel/base.html" %}
{% load static %}
{% block title %}{{ title|default:"Solicita√ß√µes" }}{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 py-6">

  {# =================== RESUMO / ALERTAS =================== #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
      <h2 class="text-sm font-semibold text-gray-800 mb-2">Alertas</h2>
      <ul class="text-sm space-y-2">
        <li>üîî {{ alertas.sem_confirmacao|default:0 }} clientes sem confirma√ß√£o</li>
        <li>‚è±Ô∏è {{ alertas.inativos_30d|default:0 }} clientes inativos h√° +30 dias</li>
        <li>üìÖ {{ alertas.solicitacoes_pendentes|default:0 }} solicita√ß√µes pendentes</li>
      </ul>
    </section>

    {# =================== FILTROS + A√á√ÉO GLOBAL =================== #}
    <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 md:col-span-2">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <h1 class="text-lg font-semibold">Solicita√ß√µes</h1>

        <a href="{% url 'agendamentos:agendamento_novo' shop.slug %}"
           class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
          <span aria-hidden="true">‚ûï</span>
          <span>Adicionar atendimento</span>
        </a>
      </div>

      <form method="get" class="mt-4 grid grid-cols-1 sm:grid-cols-[1fr_auto_auto_auto] gap-2 w-full max-w-4xl">
        <input type="text" name="q" value="{{ filters.q|default_if_none:'' }}"
               class="w-full rounded-xl border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300"
               placeholder="Buscar por nome ou telefone" aria-label="Buscar por nome ou telefone">

        {# filtro de status via partial #}
        {% include "solicitacoes/partials/_status_filter.html" with filters=filters %}

        <button class="rounded-xl px-4 py-2 bg-black text-white hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-black/40">Filtrar</button>

        <a href="{% url 'solicitacoes:solicitacoes' shop.slug %}"
           class="rounded-xl px-4 py-2 border hover:bg-gray-50 text-center focus:outline-none focus:ring-2 focus:ring-slate-300">Limpar</a>
      </form>
    </section>
  </div>

  {# =================== TABELA =================== #}
  <div class="overflow-x-auto rounded-2xl border bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-left sticky top-0 z-10">
        <tr>
          <th class="px-4 py-3 font-semibold text-gray-700">Criado</th>
          <th class="px-4 py-3 font-semibold text-gray-700">Cliente</th>
          <th class="px-4 py-3 font-semibold text-gray-700">Servi√ßo</th>
          <th class="px-4 py-3 font-semibold text-gray-700">In√≠cio</th>
          <th class="px-4 py-3 font-semibold text-gray-700">Status</th>
          <th class="px-4 py-3 font-semibold text-right text-gray-700">A√ß√µes</th>
        </tr>
      </thead>

      <tbody class="divide-y" id="rows">
        {% for s in solicitacoes %}
        <tr id="row-{{ s.id }}" class="hover:bg-gray-50">

          {# Criado #}
          <td class="px-4 py-3 align-top">
            <div class="font-medium">
              {{ s.criado_em|date:"d/m/Y H:i" }}
            </div>
            {% if s.id_externo %}
              <div class="text-gray-500 text-xs">#{{ s.id_externo }}</div>
            {% endif %}
          </td>

          {# Cliente #}
          <td class="px-4 py-3 align-top">
            <div class="font-medium truncate max-w-[220px]">
              {% firstof s.nome s.cliente_nome s.cliente.nome "‚Äî" %}
            </div>
            <div class="text-gray-500 truncate max-w-[220px]">
              {% firstof s.telefone s.cliente.telefone "‚Äî" %}
            </div>
          </td>

          {# Servi√ßo #}
          <td class="px-4 py-3 align-top">
            <div class="truncate max-w-[240px]">
              {% firstof s.servico_label s.servico_nome s.servico.nome "‚Äî" %}
            </div>
            {% if s.servico and s.servico.duracao_min %}
              <div class="text-xs text-gray-500 mt-0.5">({{ s.servico.duracao_min }} min)</div>
            {% endif %}
          </td>

          {# In√≠cio #}
          <td class="px-4 py-3 align-top">
            {% if s.inicio %}
              {{ s.inicio|date:"d/m/Y H:i" }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          {# Status #}
          <td class="px-4 py-3 align-top" id="status-{{ s.id }}">
            {% include "solicitacoes/partials/_status_badge.html" with s=s %}
          </td>

          {# A√ß√µes #}
          <td class="px-4 py-3 align-top" id="actions-{{ s.id }}">
            {% include "solicitacoes/partials/_actions.html" with s=s shop=shop %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-4 py-10 text-center text-gray-500">
            Nenhuma solicita√ß√£o encontrada.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{# =================== ESTILOS =================== #}
<style>
  .status-badge { @apply inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-medium; }
  .btn-action    { @apply inline-flex items-center justify-center rounded-xl px-3 py-1.5 text-sm transition; }
</style>

{# =================== JS =================== #}
<script>
  // --- CSRF helpers ---
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  async function postForm(url, dataObj) {
    const form = new URLSearchParams();
    Object.entries(dataObj || {}).forEach(([k, v]) => form.append(k, v ?? ''));
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
      },
      body: form.toString(),
    });
    if (!resp.ok) {
      const txt = await resp.text();
      throw new Error(`HTTP ${resp.status} - ${txt}`);
    }
    try { return await resp.json(); } catch { return {}; }
  }

  // --- A√ß√µes ---
  async function openConfirm(btn) {
    const url = btn.dataset.confirmUrl;
    const inicioDefault = btn.dataset.inicio || '';
    const inicio = prompt('Informe a data/hora do in√≠cio (YYYY-MM-DDTHH:MM)', inicioDefault);
    if (!inicio) return;

    const servicoId = btn.dataset.servicoId || '';
    const precoCotado = btn.dataset.preco || '';

    try {
      await postForm(url, { inicio, servico_id: servicoId, preco_cotado: precoCotado });
      location.reload();
    } catch (e) {
      alert('Erro ao confirmar: ' + e.message);
    }
  }

  async function openDeny(btn) {
    const url = btn.dataset.denyUrl;
    const motivo = prompt('Motivo da negativa (opcional):', '');
    try {
      await postForm(url, { motivo: motivo || '' });
      location.reload();
    } catch (e) {
      alert('Erro ao negar: ' + e.message);
    }
  }

  async function submitFinalize(btn) {
    const url = btn.dataset.finalizeUrl;
    if (!confirm('Finalizar este atendimento?')) return;
    try {
      await postForm(url, {});
      location.reload();
    } catch (e) {
      alert('Erro ao finalizar: ' + e.message);
    }
  }

  async function submitNoShow(btn) {
    const url = btn.dataset.noshowUrl;
    if (!confirm('Marcar como no-show?')) return;
    try {
      await postForm(url, {});
      location.reload();
    } catch (e) {
      alert('Erro ao marcar no-show: ' + e.message);
    }
  }

  // Expor globalmente
  window.openConfirm    = openConfirm;
  window.openDeny       = openDeny;
  window.submitFinalize = submitFinalize;
  window.submitNoShow   = submitNoShow;
</script>
{% endblock %}
