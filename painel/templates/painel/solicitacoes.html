{% extends "painel/base.html" %}
{% load static %}
{% block title %}Solicitações{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 py-6">

  {# =================== RESUMO / ALERTAS =================== #}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <section class="card p-4">
      <h2 class="section-title mb-3">📊 Alertas</h2>
      <ul class="text-sm space-y-2">
        <li>🔔 <span class="font-semibold text-rose-600">{{ alertas.sem_confirmacao|default:0 }}</span> aguardando confirmação</li>
        <li>📅 <span class="font-semibold text-indigo-600">{{ alertas.solicitacoes_pendentes|default:0 }}</span> solicitações pendentes</li>
      </ul>
    </section>

    <section class="card p-4 md:col-span-2">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <h1 class="text-lg font-semibold">Solicitações</h1>
        {% if shop %}
          <a href="{% url 'agendamentos:agendamento_novo' shop.slug %}" class="btn btn-primary">➕ Novo atendimento</a>
        {% else %}
          <button class="btn btn-secondary opacity-60 cursor-not-allowed" disabled>➕ Novo atendimento</button>
        {% endif %}
      </div>

      {# ---- Filtros ---- #}
      <form method="get" class="mt-4 form-row sm:grid-cols-[1fr_auto_auto] max-w-4xl">
        <input type="text" name="q" value="{{ filters.q|default_if_none:'' }}"
               class="ia-input input--ghost"
               placeholder="Buscar por nome ou telefone">

        {# status compatível com a view #}
        {% with st=filters.status|default:'' %}
        <select name="status" class="ia-input input--ghost w-full sm:w-auto"
                onchange="this.form.requestSubmit()">
          <option value=""           {% if st == "" %}selected{% endif %}>Todos</option>
          <option value="PENDENTE"   {% if st == "PENDENTE" %}selected{% endif %}>Pendente</option>
          <option value="CONFIRMADA" {% if st == "CONFIRMADA" %}selected{% endif %}>Confirmada (ag.)</option>
          <option value="FINALIZADA" {% if st == "FINALIZADA" %}selected{% endif %}>Finalizada (ag.)</option>
          <option value="REALIZADA"  {% if st == "REALIZADA" %}selected{% endif %}>Realizada (ag.)</option>
          <option value="NO_SHOW"    {% if st == "NO_SHOW" %}selected{% endif %}>No-show (ag.)</option>
          <option value="CANCELADA"  {% if st == "CANCELADA" %}selected{% endif %}>Cancelada/Negada (ag.)</option>
        </select>
        {% endwith %}

        <button class="btn btn-secondary">Filtrar</button>
      </form>
    </section>
  </div>

  {# =================== LISTAGEM =================== #}
  <div class="ia-table-wrap">
    <table class="ia-table text-sm">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Cliente</th>
          <th class="hidden md:table-cell">Serviço</th>
          <th>Status</th>
          <th class="text-right">Ações</th>
        </tr>
      </thead>

      <tbody id="rows">
        {# --------- MODO: SOLICITAÇÕES --------- #}
        {% if list_kind == "solicitacoes" %}
          {% for s in page_obj %}
          <tr id="row-{{ s.id }}" class="transition {% if s.status|stringformat:'s'|upper == 'PENDENTE' %}bg-amber-50{% endif %}">
            <td class="align-top">
              <div class="font-medium">
                {% if s.inicio %}{{ s.inicio|date:"d/m H:i" }}{% else %}<span class="ia-text-muted italic">A definir</span>{% endif %}
              </div>
            </td>
            <td class="align-top">
              <div class="font-medium truncate max-w-[220px]" title="{% firstof s.nome s.cliente_nome s.cliente.nome s.telefone '—' %}">
                {% firstof s.nome s.cliente_nome s.cliente.nome "—" %}
              </div>
              <div class="ia-text-muted text-xs">{% firstof s.telefone s.cliente.telefone "—" %}</div>
            </td>
            <td class="align-top hidden md:table-cell">
              <div class="truncate max-w-[240px]">{% firstof s.servico_label s.servico_nome s.servico.nome "—" %}</div>
            </td>
            <td class="align-top" id="status-{{ s.id }}">
              {% include "solicitacoes/partials/_status_badge.html" with status=s.status label=s.status size="xs" only %}
            </td>
            <td class="align-top text-right" id="actions-{{ s.id }}">
              <div class="row-actions flex justify-end gap-2">
                {% if shop %}
                  <button type="button" class="btn btn-primary"
                          data-confirm-url="{% url 'solicitacoes:confirmar' shop.slug s.id %}"
                          onclick="openConfirm(this)">✅ Confirmar</button>
                  <button type="button" class="btn btn-danger"
                          data-deny-url="{% url 'solicitacoes:recusar' shop.slug s.id %}"
                          onclick="openDeny(this)">❌ Negar</button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="px-4 py-10 text-center ia-text-muted">Nenhuma solicitação encontrada.</td></tr>
          {% endfor %}
        {% endif %}

        {# --------- MODO: AGENDAMENTOS --------- #}
        {% if list_kind == "agendamentos" %}
          {% for a in page_obj %}
          <tr id="ag-{{ a.id }}" class="transition">
            <td class="align-top">
              <div class="font-medium">
                {% if a.inicio %}{{ a.inicio|date:"d/m/Y H:i" }}{% else %}—{% endif %}
              </div>
            </td>
            <td class="align-top">
              <div class="font-medium truncate max-w-[220px]" title="{% firstof a.cliente_nome a.cliente.nome '—' %}">
                {% firstof a.cliente_nome a.cliente.nome "—" %}
              </div>
              <div class="ia-text-muted truncate max-w-[220px]">
                {% if a.cliente and a.cliente.telefone %}{{ a.cliente.telefone }}{% else %}—{% endif %}
              </div>
            </td>
            <td class="align-top hidden md:table-cell">
              <div class="truncate max-w-[240px]">{% firstof a.servico_nome a.servico.nome "—" %}</div>
            </td>
            <td class="align-top">
              {% include "solicitacoes/partials/_status_badge.html" with status=a.status label=a.status size="xs" only %}
            </td>
            <td class="align-top text-right">
              {% if a.status|stringformat:"s"|upper == "CONFIRMADO" and shop %}
                <div class="row-actions flex justify-end gap-2">
                  <button type="button" class="btn btn-primary"
                          data-finalize-url="{% url 'agendamentos:finalizar' shop.slug a.id %}"
                          onclick="submitFinalize(this)">🏁 Finalizar</button>
                  <button type="button" class="btn btn-warning"
                          data-noshow-url="{% url 'agendamentos:no_show' shop.slug a.id %}"
                          onclick="submitNoShow(this)">🚫 No-show</button>
                </div>
              {% else %}
                <a href="{% url 'solicitacoes:detalhe' shop.slug a.id %}" class="btn btn-outline">👁️ Ver</a>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="px-4 py-10 text-center ia-text-muted">Nenhum agendamento encontrado.</td></tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </div>

  {# =================== PAGINAÇÃO =================== #}
  {% if page_obj and page_obj.paginator.num_pages > 1 %}
  <nav class="mt-4 flex items-center justify-between text-sm">
    <div class="ia-text-muted">
      Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
    </div>
    <div class="flex gap-2">
      {% if page_obj.has_previous %}
        <a class="btn btn-secondary btn--sm" href="?{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.status %}status={{ filters.status }}&{% endif %}page={{ page_obj.previous_page_number }}">← Anterior</a>
      {% else %}
        <span class="btn btn-secondary btn--sm opacity-50 cursor-not-allowed">← Anterior</span>
      {% endif %}
      {% if page_obj.has_next %}
        <a class="btn btn-secondary btn--sm" href="?{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.status %}status={{ filters.status }}&{% endif %}page={{ page_obj.next_page_number }}">Próxima →</a>
      {% else %}
        <span class="btn btn-secondary btn--sm opacity-50 cursor-not-allowed">Próxima →</span>
      {% endif %}
    </div>
  </nav>
  {% endif %}
</div>
{% endblock %}
